name: Deploy Portfólios

on:
    pull_request:
        types: [closed]
        branches:
            - main

jobs:
    deploy-geral:
        if: github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'geral'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
            - name: Setup SSH key
              uses: webfactory/ssh-agent@v0.7.0
              with:
                  ssh-private-key: ${{ secrets.HOME_SERVER_SSH_KEY }}
            - name: Configure SSH
              run: |
                  mkdir -p ~/.ssh
                  echo "Host ssh.leoproti.com.br" >> ~/.ssh/config
                  echo "  StrictHostKeyChecking no" >> ~/.ssh/config
                  echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
                  chmod 600 ~/.ssh/config
            - name: Build project
              run: |
                  npm ci
                  npm run build
            - name: Prepare deploy folder
              run: |
                  mkdir -p temp-deploy
                  cp docker-compose.yml temp-deploy/
                  cp Dockerfile temp-deploy/
                  cp nginx.conf temp-deploy/
                  cp -r dist temp-deploy/
            - name: Clean and prepare server
              run: |
                  DEPLOY_PATH="/home/leonardovieiraxy/projetos/leo-portifolio/geral"
                  ssh -o ProxyCommand="cloudflared access ssh --hostname %h" leonardovieiraxy@ssh.leoproti.com.br << EOF
                    mkdir -p /home/leonardovieiraxy/projetos/leo-portifolio/
                    if [ -d "$DEPLOY_PATH" ]; then
                      cd "$DEPLOY_PATH"
                      docker compose down || true
                      cd ..
                      rm -rf "$DEPLOY_PATH"
                    fi
                    mkdir -p "$DEPLOY_PATH"
                    chmod 755 "$DEPLOY_PATH"
                  EOF
            - name: Transfer project files
              run: |
                  DEPLOY_PATH="/home/leonardovieiraxy/projetos/leo-portifolio/geral"
                  rsync -avz --delete \
                    -e "ssh -o ProxyCommand='cloudflared access ssh --hostname %h'" \
                    temp-deploy/ \
                    leonardovieiraxy@ssh.leoproti.com.br:$DEPLOY_PATH/
            - name: Deploy on server
              run: |
                  DEPLOY_PATH="/home/leonardovieiraxy/projetos/leo-portifolio/geral"
                  ssh -o ProxyCommand="cloudflared access ssh --hostname %h" leonardovieiraxy@ssh.leoproti.com.br << EOF
                    cd "$DEPLOY_PATH"
                    docker compose build --no-cache
                    docker compose up -d
                    docker compose ps
                    sleep 5
                    curl -I http://localhost:80 || echo "Site não respondeu"
                    docker system prune -f
                  EOF

    deploy-geral-github-pages:
        if: github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'geral'
        runs-on: ubuntu-latest
        needs: deploy-geral
        permissions:
            contents: read
            pages: write
            id-token: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm
            - name: Install dependencies
              run: npm ci
            - name: Build for GitHub Pages
              run: npm run build:github:linux
            - name: Upload artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  path: ./dist
            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4

    deploy-professor:
        if: github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'professor'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
            - name: Setup SSH key
              uses: webfactory/ssh-agent@v0.7.0
              with:
                  ssh-private-key: ${{ secrets.HOME_SERVER_SSH_KEY }}
            - name: Configure SSH
              run: |
                  mkdir -p ~/.ssh
                  echo "Host ssh.leoproti.com.br" >> ~/.ssh/config
                  echo "  StrictHostKeyChecking no" >> ~/.ssh/config
                  echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
                  chmod 600 ~/.ssh/config
            - name: Build project
              run: |
                  npm ci
                  npm run build
            - name: Prepare deploy folder
              run: |
                  mkdir -p temp-deploy
                  cp docker-compose.yml temp-deploy/
                  cp Dockerfile temp-deploy/
                  cp nginx.conf temp-deploy/
                  cp -r dist temp-deploy/
            - name: Clean and prepare server
              run: |
                  DEPLOY_PATH="/home/leonardovieiraxy/projetos/leo-portifolio/ensino"
                  ssh -o ProxyCommand="cloudflared access ssh --hostname %h" leonardovieiraxy@ssh.leoproti.com.br << EOF
                    mkdir -p /home/leonardovieiraxy/projetos/leo-portifolio/
                    if [ -d "$DEPLOY_PATH" ]; then
                      cd "$DEPLOY_PATH"
                      docker compose down || true
                      cd ..
                      rm -rf "$DEPLOY_PATH"
                    fi
                    mkdir -p "$DEPLOY_PATH"
                    chmod 755 "$DEPLOY_PATH"
                  EOF
            - name: Transfer project files
              run: |
                  DEPLOY_PATH="/home/leonardovieiraxy/projetos/leo-portifolio/ensino"
                  rsync -avz --delete \
                    -e "ssh -o ProxyCommand='cloudflared access ssh --hostname %h'" \
                    temp-deploy/ \
                    leonardovieiraxy@ssh.leoproti.com.br:$DEPLOY_PATH/
            - name: Deploy on server
              run: |
                  DEPLOY_PATH="/home/leonardovieiraxy/projetos/leo-portifolio/ensino"
                  ssh -o ProxyCommand="cloudflared access ssh --hostname %h" leonardovieiraxy@ssh.leoproti.com.br << EOF
                    cd "$DEPLOY_PATH"
                    docker compose build --no-cache
                    docker compose up -d
                    docker compose ps
                    sleep 5
                    curl -I http://localhost:80 || echo "Site não respondeu"
                    docker system prune -f
                  EOF

    deploy-fullstack:
        if: github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'fullstack'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
            - name: Setup SSH key
              uses: webfactory/ssh-agent@v0.7.0
              with:
                  ssh-private-key: ${{ secrets.HOME_SERVER_SSH_KEY }}
            - name: Configure SSH
              run: |
                  mkdir -p ~/.ssh
                  echo "Host ssh.leoproti.com.br" >> ~/.ssh/config
                  echo "  StrictHostKeyChecking no" >> ~/.ssh/config
                  echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
                  chmod 600 ~/.ssh/config
            - name: Build project
              run: |
                  npm ci
                  npm run build
            - name: Prepare deploy folder
              run: |
                  mkdir -p temp-deploy
                  cp docker-compose.yml temp-deploy/
                  cp Dockerfile temp-deploy/
                  cp nginx.conf temp-deploy/
                  cp -r dist temp-deploy/
            - name: Clean and prepare server
              run: |
                  DEPLOY_PATH="/home/leonardovieiraxy/projetos/leo-portifolio/fullstack"
                  ssh -o ProxyCommand="cloudflared access ssh --hostname %h" leonardovieiraxy@ssh.leoproti.com.br << EOF
                    mkdir -p /home/leonardovieiraxy/projetos/leo-portifolio/
                    if [ -d "$DEPLOY_PATH" ]; then
                      cd "$DEPLOY_PATH"
                      docker compose down || true
                      cd ..
                      rm -rf "$DEPLOY_PATH"
                    fi
                    mkdir -p "$DEPLOY_PATH"
                    chmod 755 "$DEPLOY_PATH"
                  EOF
            - name: Transfer project files
              run: |
                  DEPLOY_PATH="/home/leonardovieiraxy/projetos/leo-portifolio/fullstack"
                  rsync -avz --delete \
                    -e "ssh -o ProxyCommand='cloudflared access ssh --hostname %h'" \
                    temp-deploy/ \
                    leonardovieiraxy@ssh.leoproti.com.br:$DEPLOY_PATH/
            - name: Deploy on server
              run: |
                  DEPLOY_PATH="/home/leonardovieiraxy/projetos/leo-portifolio/fullstack"
                  ssh -o ProxyCommand="cloudflared access ssh --hostname %h" leonardovieiraxy@ssh.leoproti.com.br << EOF
                    cd "$DEPLOY_PATH"
                    docker compose build --no-cache
                    docker compose up -d
                    docker compose ps
                    sleep 5
                    curl -I http://localhost:80 || echo "Site não respondeu"
                    docker system prune -f
                  EOF

    deploy-ciencia-dados:
        if: github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'ciencia-dados'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
            - name: Setup SSH key
              uses: webfactory/ssh-agent@v0.7.0
              with:
                  ssh-private-key: ${{ secrets.HOME_SERVER_SSH_KEY }}
            - name: Configure SSH
              run: |
                  mkdir -p ~/.ssh
                  echo "Host ssh.leoproti.com.br" >> ~/.ssh/config
                  echo "  StrictHostKeyChecking no" >> ~/.ssh/config
                  echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
                  chmod 600 ~/.ssh/config
            - name: Build project
              run: |
                  npm ci
                  npm run build
            - name: Prepare deploy folder
              run: |
                  mkdir -p temp-deploy
                  cp docker-compose.yml temp-deploy/
                  cp Dockerfile temp-deploy/
                  cp nginx.conf temp-deploy/
                  cp -r dist temp-deploy/
            - name: Clean and prepare server
              run: |
                  DEPLOY_PATH="/home/leonardovieiraxy/projetos/leo-portifolio/ciencia-dados"
                  ssh -o ProxyCommand="cloudflared access ssh --hostname %h" leonardovieiraxy@ssh.leoproti.com.br << EOF
                    mkdir -p /home/leonardovieiraxy/projetos/leo-portifolio/
                    if [ -d "$DEPLOY_PATH" ]; then
                      cd "$DEPLOY_PATH"
                      docker compose down || true
                      cd ..
                      rm -rf "$DEPLOY_PATH"
                    fi
                    mkdir -p "$DEPLOY_PATH"
                    chmod 755 "$DEPLOY_PATH"
                  EOF
            - name: Transfer project files
              run: |
                  DEPLOY_PATH="/home/leonardovieiraxy/projetos/leo-portifolio/ciencia-dados"
                  rsync -avz --delete \
                    -e "ssh -o ProxyCommand='cloudflared access ssh --hostname %h'" \
                    temp-deploy/ \
                    leonardovieiraxy@ssh.leoproti.com.br:$DEPLOY_PATH/
            - name: Deploy on server
              run: |
                  DEPLOY_PATH="/home/leonardovieiraxy/projetos/leo-portifolio/ciencia-dados"
                  ssh -o ProxyCommand="cloudflared access ssh --hostname %h" leonardovieiraxy@ssh.leoproti.com.br << EOF
                    cd "$DEPLOY_PATH"
                    docker compose build --no-cache
                    docker compose up -d
                    docker compose ps
                    sleep 5
                    curl -I http://localhost:80 || echo "Site não respondeu"
                    docker system prune -f
                  EOF

    deploy-analista-dados:
        if: github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'analista-dados'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
            - name: Setup SSH key
              uses: webfactory/ssh-agent@v0.7.0
              with:
                  ssh-private-key: ${{ secrets.HOME_SERVER_SSH_KEY }}
            - name: Configure SSH
              run: |
                  mkdir -p ~/.ssh
                  echo "Host ssh.leoproti.com.br" >> ~/.ssh/config
                  echo "  StrictHostKeyChecking no" >> ~/.ssh/config
                  echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
                  chmod 600 ~/.ssh/config
            - name: Build project
              run: |
                  npm ci
                  npm run build
            - name: Prepare deploy folder
              run: |
                  mkdir -p temp-deploy
                  cp docker-compose.yml temp-deploy/
                  cp Dockerfile temp-deploy/
                  cp nginx.conf temp-deploy/
                  cp -r dist temp-deploy/
            - name: Clean and prepare server
              run: |
                  DEPLOY_PATH="/home/leonardovieiraxy/projetos/leo-portifolio/analista-dados"
                  ssh -o ProxyCommand="cloudflared access ssh --hostname %h" leonardovieiraxy@ssh.leoproti.com.br << EOF
                    mkdir -p /home/leonardovieiraxy/projetos/leo-portifolio/
                    if [ -d "$DEPLOY_PATH" ]; then
                      cd "$DEPLOY_PATH"
                      docker compose down || true
                      cd ..
                      rm -rf "$DEPLOY_PATH"
                    fi
                    mkdir -p "$DEPLOY_PATH"
                    chmod 755 "$DEPLOY_PATH"
                  EOF
            - name: Transfer project files
              run: |
                  DEPLOY_PATH="/home/leonardovieiraxy/projetos/leo-portifolio/analista-dados"
                  rsync -avz --delete \
                    -e "ssh -o ProxyCommand='cloudflared access ssh --hostname %h'" \
                    temp-deploy/ \
                    leonardovieiraxy@ssh.leoproti.com.br:$DEPLOY_PATH/
            - name: Deploy on server
              run: |
                  DEPLOY_PATH="/home/leonardovieiraxy/projetos/leo-portifolio/analista-dados"
                  ssh -o ProxyCommand="cloudflared access ssh --hostname %h" leonardovieiraxy@ssh.leoproti.com.br << EOF
                    cd "$DEPLOY_PATH"
                    docker compose build --no-cache
                    docker compose up -d
                    docker compose ps
                    sleep 5
                    curl -I http://localhost:80 || echo "Site não respondeu"
                    docker system prune -f
                  EOF
