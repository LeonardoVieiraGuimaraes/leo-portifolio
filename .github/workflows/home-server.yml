name: Deploy to Home Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: üè† Deploy to Home Server
    runs-on: ubuntu-latest
    
    steps:
      - name: üöö Checkout code
        uses: actions/checkout@v3

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: "npm"

      - name: üì¶ Install dependencies
        run: npm install

      - name: üî® Build project
        run: npm run build:homeserver

      - name: ‚òÅÔ∏è Setup Cloudflare
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: üîë Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HOME_SERVER_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ssh.leoproti.com.br >> ~/.ssh/known_hosts
          
          # Debug: verificar se a chave foi criada corretamente
          ls -la ~/.ssh/
          file ~/.ssh/id_ed25519
          ssh-keygen -l -f ~/.ssh/id_ed25519

      - name: ÔøΩ Test SSH connection
        run: |
          echo "Testing SSH connection..."
          ssh -o ProxyCommand="cloudflared access ssh --hostname %h" \
              -o ConnectTimeout=10 \
              -o StrictHostKeyChecking=no \
              leonardovieiraxy@ssh.leoproti.com.br "echo 'SSH connection successful!'"

      - name: ÔøΩüìÅ Prepare files
        run: |
          mkdir -p leo-portifolio
          cp docker-compose.yml leo-portifolio/
          cp nginx.conf leo-portifolio/
          cp -r dist leo-portifolio/dist

      - name: üì§ Transfer files
        run: |
          echo "${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}" | cloudflared tunnel login
          scp -o ProxyCommand="cloudflared access ssh --hostname %h" \
              -r leo-portifolio leonardovieiraxy@ssh.leoproti.com.br:/home/leonardovieiraxy/

      - name: üöÄ Deploy on server
        run: |
          ssh -o ProxyCommand="cloudflared access ssh --hostname %h" \
              leonardovieiraxy@ssh.leoproti.com.br << 'EOF'
            cd /home/leonardovieiraxy/leo-portifolio
            docker compose down
            docker compose up -d --build
            docker system prune -f
          EOF
